<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Audit & Simulation IA — Numérion Éducation™</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
:root{--bg:#0a0a0a;--panel:#111;--soft:#171717;--line:#222;--text:#e6e6e6;--muted:#9ca3af;--accent:#c9f31d;--ok:#0ea5e9;--warn:#f59e0b;--radius:14px;--w:1100px}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:var(--w);margin:0 auto;padding:0 20px}
.site-header{position:sticky;top:0;z-index:10;background:rgba(10,10,10,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
.site-header .wrap{display:flex;align-items:center;gap:18px;padding:10px 20px}
.btn{background:var(--accent);color:#0a0a0a;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.card{padding:24px 0;border-bottom:1px solid var(--line)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:22px} .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:22px}
.badge,.qr{background:var(--soft);border:1px solid var(--line);padding:14px;border-radius:var(--radius)}
.table-wrap{overflow:auto;border:1px solid var(--line);border-radius:10px;margin-top:8px}
table{width:100%;border-collapse:collapse} th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
.callout{margin-top:12px;padding:12px;border-radius:10px;border:1px solid var(--line);background:var(--soft)}
.small{color:var(--muted);font-size:.9rem}
</style></head><body>
<header class="site-header">
  <div class="wrap">
    <strong>Numérion Éducation™</strong>
    <div style="flex:1"></div>
    <button id="btnPrint" class="btn">Télécharger le PDF</button>
  </div>
</header>

<section class="card"><div class="wrap">
  <h1>Audit & Simulation — <span id="companyName">—</span></h1>
  <p class="small">Période: <span id="period">—</span> • Audit: <span id="auditId">—</span> • Date: <span id="auditDate">—</span></p>
  <div class="grid-3" style="margin-top:12px">
    <div class="badge"><div>Conformité</div><strong>MiCA • IFRS</strong></div>
    <div class="badge"><div>Allocation testée</div><strong>1% • 3% • 5%</strong></div>
    <div class="qr"><div id="qrcode"></div><small>Lien sécurisé</small></div>
  </div>
</div></section>

<section class="card"><div class="wrap">
  <h2>Synthèse exécutive</h2>
  <div class="grid-2">
    <div>
      <ul id="bullets"></ul>
      <div class="callout">Trésorerie actuelle: <strong id="cash">—</strong></div>
    </div>
    <div><canvas id="chartOverview" height="180"></canvas></div>
  </div>
</div></section>

<section class="card"><div class="wrap">
  <h2>Scénarios d’allocation</h2>
  <div class="grid-3">
    <div><h3>1%</h3><canvas id="chartS1" height="140"></canvas><div class="table-wrap"><table id="tableS1"></table></div></div>
    <div><h3>3%</h3><canvas id="chartS3" height="140"></canvas><div class="table-wrap"><table id="tableS3"></table></div></div>
    <div><h3>5%</h3><canvas id="chartS5" height="140"></canvas><div class="table-wrap"><table id="tableS5"></table></div></div>
  </div>
</div></section>

<section class="card"><div class="wrap">
  <h2>Opposabilité</h2>
  <p class="small">Empreinte et version:</p>
  <div class="table-wrap"><table><tbody>
    <tr><td>Commit</td><td><code id="commitHash">—</code></td></tr>
    <tr><td>Lien</td><td><span id="reportUrl">—</span></td></tr>
  </tbody></table></div>
</div></section>

<script>
const $=s=>document.querySelector(s);
const qs=new URLSearchParams(location.search);
const token=qs.get('token');
$('#btnPrint').onclick=()=>window.print();

async function load(){
  if(!token){ document.body.innerHTML='<div class="wrap"><h2>Token manquant</h2></div>'; return;}
  const r=await fetch('/.netlify/functions/get-audit?token='+encodeURIComponent(token));
  if(!r.ok){ document.body.innerHTML='<div class="wrap"><h2>Token invalide</h2></div>'; return;}
  const data=await r.json();

  const eur = v => Number(v||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
  // Bind
  $('#companyName').textContent=data.company.name;
  $('#period').textContent=data.company.period;
  $('#auditId').textContent=data.company.auditId;
  $('#auditDate').textContent=data.company.date;
  $('#cash').textContent=eur(data.company.cash);
  $('#commitHash').textContent=data.security.commitHash;
  $('#reportUrl').textContent=data.reportUrl;
  new QRCode(document.getElementById('qrcode'), { text: location.href, width: 92, height: 92 });

  // Bullets par défaut + notes saisies
  const bullets = [
    "Allocation progressive 1–5 % sous gouvernance duale.",
    "Exposition prioritaire BTC/ETH via PSAN régulé.",
    "Fenêtres de sortie trimestrielles alignées besoins CAPEX.",
    "Drawdown capé sur trésorerie totale.",
  ];
  if (data.notes) bullets.push("Notes client: "+data.notes);
  const ul=$('#bullets'); ul.innerHTML=''; bullets.forEach(t=>{const li=document.createElement('li'); li.textContent=t; ul.appendChild(li);});

  // Charts
  const labels = Array.from({length:data.scenarios.horizonMonths},(_,i)=>'M'+(i+1));
  const ds=(label,data)=>({label,data,tension:.25,pointRadius:0});
  const cfg=(ctx,labels,datasets)=>new Chart(ctx,{type:'line',data:{labels,datasets},
     options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#e6e6e6'}}},
     scales:{x:{ticks:{color:'#9ca3af'},grid:{color:'#222'}},y:{ticks:{color:'#9ca3af'},grid:{color:'#222'}}}}});

  cfg($('#chartOverview'),labels,[
    ds('Baseline', data.scenarios.baseline),
    ds('1 %', data.scenarios.series[0].monthly),
    ds('3 %', data.scenarios.series[1].monthly),
    ds('5 %', data.scenarios.series[2].monthly),
  ]);

  function table(elId, serie, baseline){
    const t=document.getElementById(elId); const bl=baseline;
    const eur=v=>Number(v).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
    t.innerHTML=`<thead><tr><th>Mois</th><th>Baseline</th><th>Scénario</th><th>Écart</th></tr></thead>
    <tbody>${
      serie.monthly.map((v,i)=>{const b=bl[i]??bl.at(-1);const g=v-b;
        return `<tr><td>M${i+1}</td><td>${eur(b)}</td><td>${eur(v)}</td><td>${g>=0?'+':''}${eur(g)}</td></tr>`;
      }).join('')
    }</tbody>`;
  }
  table('tableS1', data.scenarios.series[0], data.scenarios.baseline);
  table('tableS3', data.scenarios.series[1], data.scenarios.baseline);
  table('tableS5', data.scenarios.series[2], data.scenarios.baseline);

  cfg($('#chartS1'),labels,[ds('Baseline',data.scenarios.baseline),ds('1 %',data.scenarios.series[0].monthly)]);
  cfg($('#chartS3'),labels,[ds('Baseline',data.scenarios.baseline),ds('3 %',data.scenarios.series[1].monthly)]);
  cfg($('#chartS5'),labels,[ds('Baseline',data.scenarios.baseline),ds('5 %',data.scenarios.series[2].monthly)]);
}
load();
</script>
</body></html>
